<#
.SYNOPSIS
    Script de prÃ©paration du TP2 - CrÃ©ation d'une GPO avec 3 bugs cumulÃ©s pour l'exercice de dÃ©pannage

.DESCRIPTION
    Ce script crÃ©e volontairement une GPO avec 3 erreurs de configuration cumulÃ©es pour permettre
    aux Ã©tudiants de pratiquer le diagnostic et la rÃ©solution de problÃ¨mes GPO.
    
    Les 3 bugs introduits simultanÃ©ment :
    1. Utilisateur dans la mauvaise OU (CN=Users au lieu de OU=Comptabilite)
    2. Lien GPO dÃ©sactivÃ© (icÃ´ne grisÃ©e dans GPMC)
    3. Filtrage de sÃ©curitÃ© incorrect (utilisateur non autorisÃ©)

.PARAMETER DomainName
    Nom du domaine (par dÃ©faut : dÃ©tectÃ© automatiquement)

.PARAMETER UserName
    Nom de l'utilisateur de test (par dÃ©faut : jmartin)

.EXAMPLE
    .\Prepare-TP2-GPO-Buggy.ps1
    CrÃ©e l'environnement avec les 3 bugs cumulÃ©s

.EXAMPLE
    .\Prepare-TP2-GPO-Buggy.ps1 -UserName "alice" -DomainName "formation.lan"
    CrÃ©e l'environnement pour l'utilisateur alice sur le domaine formation.lan

.NOTES
    Auteur  : BTS SIO SISR
    Version : 2.0
    PrÃ©requis : 
    - ExÃ©cution sur un contrÃ´leur de domaine
    - Module ActiveDirectory et GroupPolicy installÃ©s
    - Droits administrateur de domaine
    - OU @xxx.lan (ou .lab, .xx) avec sous-OU Utilisateurs dÃ©jÃ  crÃ©Ã©e
#>

[CmdletBinding()]
param(
    [Parameter(Mandatory=$false)]
    [string]$DomainName = "",
    
    [Parameter(Mandatory=$false)]
    [string]$UserName = "jmartin"
)

# ============================================================================
# VÃ‰RIFICATIONS PRÃ‰ALABLES
# ============================================================================

Write-Host "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" -ForegroundColor Cyan
Write-Host "  PRÃ‰PARATION TP2 - GPO MAL CONFIGURÃ‰E" -ForegroundColor Cyan
Write-Host "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" -ForegroundColor Cyan
Write-Host ""

# VÃ©rifier les modules
Write-Host "[1/4] VÃ©rification des modules PowerShell..." -ForegroundColor Yellow
$requiredModules = @("ActiveDirectory", "GroupPolicy")
foreach ($module in $requiredModules) {
    if (-not (Get-Module -ListAvailable -Name $module)) {
        Write-Host "âŒ Module $module non disponible. Installez les outils RSAT." -ForegroundColor Red
        exit 1
    }
    Import-Module $module -ErrorAction SilentlyContinue
}
Write-Host "âœ… Modules chargÃ©s avec succÃ¨s" -ForegroundColor Green
Write-Host ""

# VÃ©rifier qu'on est sur un DC
Write-Host "[2/4] VÃ©rification du rÃ´le contrÃ´leur de domaine..." -ForegroundColor Yellow
try {
    $domain = Get-ADDomain -ErrorAction Stop
    Write-Host "âœ… Domaine dÃ©tectÃ© : $($domain.DNSRoot)" -ForegroundColor Green
    
    # Si DomainName n'est pas spÃ©cifiÃ©, utiliser le domaine dÃ©tectÃ©
    if ([string]::IsNullOrEmpty($DomainName)) {
        $DomainName = $domain.DNSRoot
    }
} catch {
    Write-Host "âŒ Ce script doit Ãªtre exÃ©cutÃ© sur un contrÃ´leur de domaine" -ForegroundColor Red
    exit 1
}
Write-Host ""

# ============================================================================
# VARIABLES
# ============================================================================

$GPOName = "GPO_Compta_Restrictions"
# La structure sera : OU=Comptabilite,OU=Utilisateurs,OU=@xxx.lan (dÃ©tectÃ© plus tard)
# $OUComptabilite sera dÃ©fini aprÃ¨s dÃ©tection de l'OU racine
$OUMauvaise = "CN=Users,$($domain.DistinguishedName)"
$UserFullName = "$UserName@$DomainName"
$GroupeTest = "Groupe_Compta_Restreints"

# ============================================================================
# NETTOYAGE PRÃ‰ALABLE (si dÃ©jÃ  exÃ©cutÃ©)
# ============================================================================

Write-Host "[3/7] Nettoyage des objets existants (si prÃ©sents)..." -ForegroundColor Yellow

# Supprimer la GPO si elle existe
try {
    $existingGPO = Get-GPO -Name $GPOName -ErrorAction SilentlyContinue
    if ($existingGPO) {
        Remove-GPO -Name $GPOName -Confirm:$false
        Write-Host "  âœ GPO '$GPOName' supprimÃ©e" -ForegroundColor Gray
    }
} catch {}

# Supprimer le groupe de test s'il existe
try {
    $existingGroup = Get-ADGroup -Identity $GroupeTest -ErrorAction SilentlyContinue
    if ($existingGroup) {
        Remove-ADGroup -Identity $GroupeTest -Confirm:$false
        Write-Host "  âœ Groupe '$GroupeTest' supprimÃ©" -ForegroundColor Gray
    }
} catch {}

Write-Host "âœ… Nettoyage terminÃ©" -ForegroundColor Green
Write-Host ""

# ============================================================================
# DÃ‰TECTION DE LA STRUCTURE D'OU (OU @xxx.lan/lab/xx et OU Utilisateurs)
# ============================================================================

Write-Host "[4/7] DÃ©tection de la structure d'OU existante..." -ForegroundColor Yellow

# Chercher une OU commenÃ§ant par @ (ex: @labo.lan, @prenom.lab, @formation.local, @test.xx)
$ouRacine = Get-ADOrganizationalUnit -Filter 'Name -like "@*.*"' -SearchBase $domain.DistinguishedName -SearchScope OneLevel | Select-Object -First 1

if (-not $ouRacine) {
    # Essayer aussi sans point (au cas oÃ¹ : @labo, @formation, etc.)
    $ouRacine = Get-ADOrganizationalUnit -Filter 'Name -like "@*"' -SearchBase $domain.DistinguishedName -SearchScope OneLevel | Select-Object -First 1
}

if (-not $ouRacine) {
    Write-Host "  âš ï¸  Aucune OU commenÃ§ant par '@' trouvÃ©e Ã  la racine du domaine" -ForegroundColor Yellow
    Write-Host "  â„¹ï¸  CrÃ©ation de la structure par dÃ©faut : OU=@$($domain.DNSRoot)" -ForegroundColor Cyan
    
    # CrÃ©er l'OU racine @domaine.extension
    $ouRacineName = "@$($domain.DNSRoot)"
    try {
        New-ADOrganizationalUnit -Name $ouRacineName -Path $domain.DistinguishedName -ProtectedFromAccidentalDeletion $false
        $ouRacine = Get-ADOrganizationalUnit -Filter "Name -eq '$ouRacineName'"
        Write-Host "  âœ OU '$ouRacineName' crÃ©Ã©e" -ForegroundColor Gray
    } catch {
        Write-Host "  âŒ Erreur lors de la crÃ©ation de l'OU racine : $_" -ForegroundColor Red
        exit 1
    }
} else {
    Write-Host "  âœ… OU racine trouvÃ©e : $($ouRacine.Name)" -ForegroundColor Green
}

# Chercher une OU "Utilisateurs" dans l'OU racine
$ouUtilisateurs = Get-ADOrganizationalUnit -Filter 'Name -eq "Utilisateurs"' -SearchBase $ouRacine.DistinguishedName -SearchScope OneLevel -ErrorAction SilentlyContinue

if (-not $ouUtilisateurs) {
    Write-Host "  âš ï¸  OU 'Utilisateurs' non trouvÃ©e dans $($ouRacine.Name)" -ForegroundColor Yellow
    Write-Host "  â„¹ï¸  CrÃ©ation de OU=Utilisateurs" -ForegroundColor Cyan
    
    try {
        New-ADOrganizationalUnit -Name "Utilisateurs" -Path $ouRacine.DistinguishedName -ProtectedFromAccidentalDeletion $false
        $ouUtilisateurs = Get-ADOrganizationalUnit -Filter "Name -eq 'Utilisateurs'" -SearchBase $ouRacine.DistinguishedName -SearchScope OneLevel
        Write-Host "  âœ OU 'Utilisateurs' crÃ©Ã©e dans $($ouRacine.Name)" -ForegroundColor Gray
    } catch {
        Write-Host "  âŒ Erreur lors de la crÃ©ation de l'OU Utilisateurs : $_" -ForegroundColor Red
        exit 1
    }
} else {
    Write-Host "  âœ… OU 'Utilisateurs' trouvÃ©e : $($ouUtilisateurs.DistinguishedName)" -ForegroundColor Green
}

$OUUtilisateursPath = $ouUtilisateurs.DistinguishedName

# DÃ©finir les chemins complets maintenant qu'on a dÃ©tectÃ© la structure
$OUComptabilite = "OU=Comptabilite,$OUUtilisateursPath"

Write-Host "  â„¹ï¸  Structure cible : $OUComptabilite" -ForegroundColor Cyan
Write-Host ""

# ============================================================================
# CRÃ‰ATION DE L'INFRASTRUCTURE DE BASE
# ============================================================================

Write-Host "[5/7] CrÃ©ation de l'infrastructure de base..." -ForegroundColor Yellow

# CrÃ©er l'OU Comptabilite dans OU=Utilisateurs si elle n'existe pas
try {
    $ouExists = Get-ADOrganizationalUnit -Filter "DistinguishedName -eq '$OUComptabilite'" -ErrorAction SilentlyContinue
    if (-not $ouExists) {
        New-ADOrganizationalUnit -Name "Comptabilite" -Path $OUUtilisateursPath -ProtectedFromAccidentalDeletion $false
        Write-Host "  âœ OU 'Comptabilite' crÃ©Ã©e dans OU=Utilisateurs,$($ouRacine.Name)" -ForegroundColor Gray
    } else {
        Write-Host "  âœ OU 'Comptabilite' dÃ©jÃ  existante" -ForegroundColor Gray
    }
} catch {
    Write-Host "âš ï¸  Erreur lors de la crÃ©ation de l'OU Comptabilite : $_" -ForegroundColor Yellow
}

# CrÃ©er l'utilisateur jmartin si il n'existe pas
Write-Host "  âœ VÃ©rification de l'utilisateur '$UserName'..." -ForegroundColor Gray
try {
    $userExists = Get-ADUser -Filter "SamAccountName -eq '$UserName'" -ErrorAction SilentlyContinue
    if (-not $userExists) {
        # CrÃ©er l'utilisateur dans OU=Comptabilite (il sera dÃ©placÃ© ensuite dans CN=Users pour le bug 1)
        $userCreationPath = $OUComptabilite
        Write-Host "  âœ CrÃ©ation de '$UserName' dans OU=Comptabilite,OU=Utilisateurs,$($ouRacine.Name)" -ForegroundColor Gray
        
        $userParams = @{
            Name = "Jacques Martin"
            GivenName = "Jacques"
            Surname = "Martin"
            SamAccountName = $UserName
            UserPrincipalName = $UserFullName
            Path = $userCreationPath
            AccountPassword = (ConvertTo-SecureString "P@ssw0rd123!" -AsPlainText -Force)
            Enabled = $true
            ChangePasswordAtLogon = $false
            PasswordNeverExpires = $true
        }
        New-ADUser @userParams
        Write-Host "  âœ… Utilisateur '$UserName' crÃ©Ã© avec succÃ¨s" -ForegroundColor Green
    } else {
        Write-Host "  âœ Utilisateur '$UserName' dÃ©jÃ  existant" -ForegroundColor Gray
    }
} catch {
    Write-Host "  âŒ Erreur lors de la crÃ©ation de l'utilisateur : $_" -ForegroundColor Red
    Write-Host "  â„¹ï¸  DÃ©tails : $($_.Exception.Message)" -ForegroundColor Yellow
}

# CrÃ©er le groupe de test
try {
    New-ADGroup -Name $GroupeTest -GroupScope Global -GroupCategory Security -Path $OUComptabilite
    Write-Host "  âœ Groupe '$GroupeTest' crÃ©Ã©" -ForegroundColor Gray
} catch {
    Write-Host "âš ï¸  Erreur lors de la crÃ©ation du groupe : $_" -ForegroundColor Yellow
}

Write-Host "âœ… Infrastructure de base prÃªte" -ForegroundColor Green
Write-Host ""

# ============================================================================
# CRÃ‰ATION DE LA GPO ET CONFIGURATION DU BUG
# ============================================================================

Write-Host "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" -ForegroundColor Cyan
Write-Host "  CONFIGURATION DU SCÃ‰NARIO $ScenarioNumber" -ForegroundColor Cyan
Write-Host "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" -ForegroundColor Cyan
Write-Host ""

# CrÃ©er la GPO
Write-Host "[6/7] CrÃ©ation de la GPO '$GPOName'..." -ForegroundColor Yellow
$gpo = New-GPO -Name $GPOName -Comment "GPO de test pour TP2 - DÃ©pannage"

# Configurer le paramÃ¨tre : Bloquer l'accÃ¨s au Panneau de configuration
Write-Host "Configuration du paramÃ¨tre : Bloquer le Panneau de configuration..." -ForegroundColor Yellow
$regPath = "HKCU\Software\Microsoft\Windows\CurrentVersion\Policies\Explorer"
Set-GPRegistryValue -Name $GPOName -Key $regPath -ValueName "NoControlPanel" -Type DWord -Value 1
Write-Host "âœ… ParamÃ¨tre configurÃ© (NoControlPanel = 1)" -ForegroundColor Green
Write-Host ""

# ============================================================================
# APPLICATION DES SCÃ‰NARIOS DE BUG (CUMUL DE 3 PROBLÃˆMES)
# ============================================================================

Write-Host "[7/7] Application des scÃ©narios de bug (3 problÃ¨mes cumulÃ©s)..." -ForegroundColor Yellow
Write-Host ""

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# BUG 1 : Utilisateur dans la mauvaise OU
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Write-Host "ğŸ› BUG 1 : Utilisateur dans la mauvaise OU" -ForegroundColor Red
Write-Host "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€" -ForegroundColor Gray

# Lier la GPO normalement
New-GPLink -Name $GPOName -Target $OUComptabilite

# DÃ©placer l'utilisateur dans CN=Users (s'il n'y est pas dÃ©jÃ )
$user = Get-ADUser -Identity $UserName
$currentUserOU = $user.DistinguishedName -replace "^CN=$UserName,", ""
if ($currentUserOU -ne $OUMauvaise) {
    Write-Host "  âœ DÃ©placement de '$UserName' vers CN=Users" -ForegroundColor Gray
    Move-ADObject -Identity $user.DistinguishedName -TargetPath $OUMauvaise
}

Write-Host "  âœ… GPO liÃ©e Ã  OU=Comptabilite,OU=Utilisateurs,$($ouRacine.Name)" -ForegroundColor Green
Write-Host "  âŒ Utilisateur '$UserName' dÃ©placÃ© dans CN=Users (hors de l'OU ciblÃ©e)" -ForegroundColor Yellow
Write-Host ""

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# BUG 2 : Lien GPO dÃ©sactivÃ©
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Write-Host "ğŸ› BUG 2 : Lien GPO dÃ©sactivÃ©" -ForegroundColor Red
Write-Host "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€" -ForegroundColor Gray

# DÃ©sactiver le lien de la GPO
Set-GPLink -Guid $gpo.Id -Target $OUComptabilite -LinkEnabled No

Write-Host "  âœ… GPO crÃ©Ã©e et liÃ©e" -ForegroundColor Green
Write-Host "  âŒ Lien GPO DÃ‰SACTIVÃ‰ (icÃ´ne grisÃ©e dans GPMC)" -ForegroundColor Yellow
Write-Host ""

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# BUG 3 : Filtrage de sÃ©curitÃ© incorrect
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Write-Host "ğŸ› BUG 3 : Filtrage de sÃ©curitÃ© incorrect" -ForegroundColor Red
Write-Host "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€" -ForegroundColor Gray

# RÃ©cupÃ©rer les SID des groupes bien connus
$domainSID = (Get-ADDomain).DomainSID.Value
$authenticatedUsersSID = New-Object System.Security.Principal.SecurityIdentifier("S-1-5-11")
$domainAdminsSID = New-Object System.Security.Principal.SecurityIdentifier("$domainSID-512")
$domainComputersSID = New-Object System.Security.Principal.SecurityIdentifier("$domainSID-515")

Write-Host "  âœ RÃ©cupÃ©ration de l'objet GPO..." -ForegroundColor Gray
$gpoObject = Get-GPO -Name $GPOName

# Obtenir le chemin AD de la GPO
$gpoADPath = "CN={$($gpoObject.Id)},CN=Policies,CN=System,$($domain.DistinguishedName)"

Write-Host "  âœ Modification des ACL de sÃ©curitÃ© de la GPO..." -ForegroundColor Gray

# Obtenir l'objet AD de la GPO pour manipuler ses ACL
$gpoADObject = [ADSI]"LDAP://$gpoADPath"
$acl = $gpoADObject.ObjectSecurity

# Supprimer TOUTES les ACE (Access Control Entry) pour "Authenticated Users" (S-1-5-11)
$acesToRemove = @()
foreach ($ace in $acl.Access) {
    if ($ace.IdentityReference.Translate([System.Security.Principal.SecurityIdentifier]).Value -eq "S-1-5-11") {
        $acesToRemove += $ace
    }
}

foreach ($ace in $acesToRemove) {
    $acl.RemoveAccessRule($ace) | Out-Null
    Write-Host "    âœ ACE retirÃ©e pour Authenticated Users" -ForegroundColor Gray
}

# Obtenir le SID du groupe Groupe_Compta_Restreints
$groupeSID = (Get-ADGroup -Identity $GroupeTest).SID

# CrÃ©er les nouvelles ACE pour le groupe restreint
# Droit GpoApply = READ (0x20094) + APPLY_GROUP_POLICY (0x100)
$gpoApplyRights = [System.DirectoryServices.ActiveDirectoryRights]::GenericRead -bor 
                  [System.DirectoryServices.ActiveDirectoryRights]::ReadProperty -bor
                  [System.DirectoryServices.ActiveDirectoryRights]::GenericExecute

$aceGroupe = New-Object System.DirectoryServices.ActiveDirectoryAccessRule(
    $groupeSID,
    $gpoApplyRights,
    [System.Security.AccessControl.AccessControlType]::Allow,
    [System.DirectoryServices.ActiveDirectorySecurityInheritance]::None
)

$acl.AddAccessRule($aceGroupe)
Write-Host "    âœ ACE ajoutÃ©e pour '$GroupeTest'" -ForegroundColor Gray

# Appliquer les modifications
$gpoADObject.ObjectSecurity = $acl
$gpoADObject.CommitChanges()

# Attendre un peu que les changements se propagent
Start-Sleep -Seconds 2

# IMPORTANT : Ajouter aussi via Set-GPPermission pour que Ã§a apparaisse dans GPMC
Write-Host "  âœ Ajout du groupe '$GroupeTest' au filtrage de sÃ©curitÃ©..." -ForegroundColor Gray
try {
    Set-GPPermission -Name $GPOName -TargetName $GroupeTest -TargetType Group -PermissionLevel GpoApply -ErrorAction Stop
    Write-Host "    âœ“ Groupe '$GroupeTest' ajoutÃ© au filtrage" -ForegroundColor Green
} catch {
    Write-Host "    âš ï¸  Erreur lors de l'ajout : $_" -ForegroundColor Yellow
}

Write-Host "  âœ… ACL modifiÃ©es et filtrage configurÃ©" -ForegroundColor Green
Write-Host "  âŒ Filtrage : seul '$GroupeTest' peut appliquer (jmartin N'EN EST PAS membre)" -ForegroundColor Yellow
Write-Host ""

# VÃ©rification finale via Get-GPPermission
Write-Host "  ğŸ“‹ VÃ©rification du filtrage de sÃ©curitÃ© final :" -ForegroundColor Cyan
Start-Sleep -Seconds 2  # Laisser le temps Ã  AD de se mettre Ã  jour
try {
    $finalPerms = Get-GPPermission -Name $GPOName -All | Where-Object {$_.Permission -eq "GpoApply" -or $_.Permission -match "Apply"}
    if ($finalPerms) {
        foreach ($p in $finalPerms) {
            Write-Host "    âœ“ $($p.Trustee.Name) â†’ $($p.Permission)" -ForegroundColor White
        }
    } else {
        Write-Host "    âœ“ Aucun groupe avec GpoApply (vÃ©rifie dans GPMC)" -ForegroundColor Yellow
    }
} catch {
    Write-Host "    âš ï¸  Impossible de lire les permissions (vÃ©rifie manuellement dans GPMC)" -ForegroundColor Yellow
}
Write-Host ""

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# RÃ‰CAPITULATIF DES BUGS
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Write-Host "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" -ForegroundColor Cyan
Write-Host "  RÃ‰CAPITULATIF DES BUGS INTRODUITS" -ForegroundColor Cyan
Write-Host "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" -ForegroundColor Cyan
Write-Host ""

Write-Host "ğŸ“‹ DIAGNOSTIC ATTENDU (3 problÃ¨mes Ã  trouver) :" -ForegroundColor Yellow
Write-Host ""
Write-Host "1ï¸âƒ£  UTILISATEUR MAL PLACÃ‰" -ForegroundColor Red
Write-Host "   â€¢ âŒ jmartin est dans CN=Users au lieu de OU=Comptabilite" -ForegroundColor White
Write-Host "   â€¢ ConsÃ©quence : La GPO ne peut pas s'appliquer (hors pÃ©rimÃ¨tre)" -ForegroundColor Gray
Write-Host "   â€¢ Commande diagnostic : Get-ADUser jmartin | Select DistinguishedName" -ForegroundColor Cyan
Write-Host ""

Write-Host "2ï¸âƒ£  LIEN GPO DÃ‰SACTIVÃ‰" -ForegroundColor Red
Write-Host "   â€¢ âŒ Le lien GPO est dÃ©sactivÃ© (icÃ´ne grisÃ©e dans GPMC)" -ForegroundColor White
Write-Host "   â€¢ ConsÃ©quence : La GPO ne sera jamais appliquÃ©e mÃªme si l'utilisateur est au bon endroit" -ForegroundColor Gray
Write-Host "   â€¢ VÃ©rification : GPMC â†’ OU=Comptabilite â†’ Observer l'icÃ´ne du lien" -ForegroundColor Cyan
Write-Host ""

Write-Host "3ï¸âƒ£  FILTRAGE DE SÃ‰CURITÃ‰ INCORRECT" -ForegroundColor Red
Write-Host "   â€¢ âŒ Seul le groupe '$GroupeTest' peut appliquer la GPO" -ForegroundColor White
Write-Host "   â€¢ âŒ jmartin n'est PAS membre de ce groupe" -ForegroundColor White
Write-Host "   â€¢ ConsÃ©quence : MÃªme avec lien actif et bon emplacement, la GPO sera refusÃ©e" -ForegroundColor Gray
Write-Host "   â€¢ VÃ©rification : GPMC â†’ GPO â†’ Onglet 'Ã‰tendue' â†’ Section 'Filtrage de sÃ©curitÃ©'" -ForegroundColor Cyan
Write-Host ""

Write-Host "ğŸ”§ SOLUTIONS (dans l'ordre recommandÃ©) :" -ForegroundColor Green
Write-Host ""
Write-Host "1ï¸âƒ£  DÃ©placer jmartin de CN=Users vers OU=Comptabilite,OU=Utilisateurs,$($ouRacine.Name)" -ForegroundColor White
Write-Host "   â†’ MÃ©thode : dsa.msc â†’ Rechercher jmartin â†’ Clic droit â†’ DÃ©placer" -ForegroundColor Gray
Write-Host ""
Write-Host "2ï¸âƒ£  Activer le lien GPO dans GPMC" -ForegroundColor White
Write-Host "   â†’ MÃ©thode : GPMC â†’ Clic droit sur le lien â†’ Cocher 'Lien activÃ©'" -ForegroundColor Gray
Write-Host ""
Write-Host "3ï¸âƒ£  Corriger le filtrage de sÃ©curitÃ© (2 options)" -ForegroundColor White
Write-Host "   â†’ Option A : Ajouter jmartin au groupe '$GroupeTest'" -ForegroundColor Gray
Write-Host "   â†’ Option B : Ajouter 'Utilisateurs authentifiÃ©s' au filtrage de sÃ©curitÃ©" -ForegroundColor Gray
Write-Host ""

Write-Host ""
Write-Host "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" -ForegroundColor Cyan
Write-Host "  RÃ‰CAPITULATIF DE LA CONFIGURATION" -ForegroundColor Cyan
Write-Host "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" -ForegroundColor Cyan
Write-Host ""
Write-Host "ğŸ“Œ Informations de base :" -ForegroundColor Yellow
Write-Host "   â€¢ Domaine       : $($domain.DNSRoot)" -ForegroundColor White
Write-Host "   â€¢ GPO crÃ©Ã©e     : $GPOName" -ForegroundColor White
Write-Host "   â€¢ Structure OU  : $($ouRacine.Name) â†’ OU=Utilisateurs â†’ OU=Comptabilite" -ForegroundColor White
Write-Host "   â€¢ OU cible GPO  : OU=Comptabilite,OU=Utilisateurs,$($ouRacine.Name)" -ForegroundColor White
Write-Host "   â€¢ Utilisateur   : $UserName" -ForegroundColor White
Write-Host "   â€¢ Mot de passe  : P@ssw0rd123!" -ForegroundColor White
Write-Host "   â€¢ ParamÃ¨tre GPO : Bloquer le Panneau de configuration" -ForegroundColor White
Write-Host ""
Write-Host "ğŸ› Bugs introduits : 3 problÃ¨mes cumulÃ©s" -ForegroundColor Red
Write-Host ""
Write-Host "ğŸ“š Pour le formateur :" -ForegroundColor Magenta
Write-Host "   â€¢ Les Ã©tudiants doivent diagnostiquer et corriger les 3 bugs" -ForegroundColor White
Write-Host "   â€¢ Ordre de rÃ©solution recommandÃ© : 1â†’2â†’3 (utilisateur, lien, filtrage)" -ForegroundColor White
Write-Host "   â€¢ Solution dÃ©taillÃ©e affichÃ©e ci-dessus pour votre rÃ©fÃ©rence" -ForegroundColor White
Write-Host "   â€¢ Fichier de rÃ©fÃ©rence gÃ©nÃ©rÃ© dans C:\TP2_Solution.txt" -ForegroundColor White
Write-Host ""
Write-Host "âœ… Configuration terminÃ©e ! Les Ã©tudiants peuvent commencer le TP2." -ForegroundColor Green
Write-Host ""

# ============================================================================
# GÃ‰NÃ‰RATION D'UN FICHIER DE RÃ‰FÃ‰RENCE POUR LE FORMATEUR
# ============================================================================

$referenceFile = "C:\TP2_Solution.txt"
$referenceContent = @"
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  TP2 - SOLUTION DES 3 BUGS CUMULÃ‰S
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Date de crÃ©ation : $(Get-Date -Format "dd/MM/yyyy HH:mm")
Domaine : $($domain.DNSRoot)

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
CONFIGURATION DE BASE
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â€¢ GPO        : $GPOName
â€¢ Structure  : $($ouRacine.Name) â†’ OU=Utilisateurs â†’ OU=Comptabilite
â€¢ OU cible   : OU=Comptabilite,OU=Utilisateurs,$($ouRacine.Name)
â€¢ Utilisateur: $UserName (mot de passe : P@ssw0rd123!)
â€¢ ParamÃ¨tre  : HKCU\Software\Microsoft\Windows\CurrentVersion\Policies\Explorer\NoControlPanel = 1

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
3 PROBLÃˆMES INTRODUITS (Ã€ CORRIGER DANS L'ORDRE)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

ğŸ› BUG 1 : UTILISATEUR DANS LA MAUVAISE OU

SYMPTÃ”ME :
L'utilisateur $UserName est dans CN=Users au lieu de OU=Comptabilite,OU=Utilisateurs,$($ouRacine.Name).
La GPO ne s'applique pas car l'utilisateur n'est pas dans le pÃ©rimÃ¨tre.

DIAGNOSTIC :
1. Ouvrir dsa.msc (Utilisateurs et ordinateurs Active Directory)
2. Rechercher $UserName (Ctrl+F)
3. Observer qu'il est dans CN=Users et non dans l'OU Comptabilite
4. gpresult ne montrera PAS la GPO dans les GPO appliquÃ©es

SOLUTION :
DÃ©placer $UserName de CN=Users vers OU=Comptabilite,OU=Utilisateurs,$($ouRacine.Name)
Commande PowerShell : 
  `$user = Get-ADUser -Identity $UserName
  Move-ADObject -Identity `$user.DistinguishedName -TargetPath "OU=Comptabilite,OU=Utilisateurs,$($ouRacine.DistinguishedName)"

Ou via GUI : Clic droit â†’ DÃ©placer â†’ Naviguer jusqu'Ã  OU=Comptabilite

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ› BUG 2 : LIEN GPO DÃ‰SACTIVÃ‰

SYMPTÃ”ME :
Le lien GPO est dÃ©sactivÃ© (icÃ´ne grisÃ©e dans GPMC).
MÃªme si l'utilisateur est dans la bonne OU, la GPO ne s'appliquera jamais.

DIAGNOSTIC :
1. Ouvrir GPMC (gpmc.msc)
2. Naviguer vers $($domain.DNSRoot) â†’ $($ouRacine.Name) â†’ OU=Utilisateurs â†’ OU=Comptabilite
3. Observer que le lien GPO_Compta_Restrictions apparaÃ®t GRISÃ‰
4. VÃ©rifier l'Ã©tat du lien (case "Lien activÃ©" dÃ©cochÃ©e)

SOLUTION :
Activer le lien dans GPMC
Commande PowerShell :
  Set-GPLink -Guid (Get-GPO -Name "$GPOName").Id -Target "OU=Comptabilite,OU=Utilisateurs,$($ouRacine.DistinguishedName)" -LinkEnabled Yes

Ou via GUI : Clic droit sur le lien â†’ Cocher "Lien activÃ©"

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ› BUG 3 : FILTRAGE DE SÃ‰CURITÃ‰ INCORRECT

SYMPTÃ”ME :
Le filtrage de sÃ©curitÃ© ne contient que le groupe '$GroupeTest',
et $UserName N'EN EST PAS membre. "Utilisateurs authentifiÃ©s" a Ã©tÃ© retirÃ©.
MÃªme avec lien actif et bon emplacement, la GPO sera refusÃ©e.

DIAGNOSTIC :
1. Dans GPMC, sÃ©lectionner GPO_Compta_Restrictions
2. Onglet "Ã‰tendue" â†’ Section "Filtrage de sÃ©curitÃ©"
3. Observer que seul '$GroupeTest' apparaÃ®t (pas "Utilisateurs authentifiÃ©s")
4. VÃ©rifier l'appartenance : Get-ADGroupMember '$GroupeTest'
   â†’ $UserName n'en est PAS membre
5. gpresult montrera la GPO dans "GPO refusÃ©es" ou "GPO filtrÃ©es"

SOLUTION (2 options au choix) :

Option A : Ajouter $UserName au groupe '$GroupeTest'
Commande PowerShell :
  Add-ADGroupMember -Identity '$GroupeTest' -Members $UserName

Option B : Ajouter "Utilisateurs authentifiÃ©s" au filtrage de sÃ©curitÃ©
Via GUI : 
  1. GPMC â†’ GPO_Compta_Restrictions â†’ Onglet Ã‰tendue
  2. Section Filtrage de sÃ©curitÃ© â†’ Bouton Ajouter
  3. Taper "Utilisateurs authentifiÃ©s" â†’ OK
  4. S'assurer que la permission est "Lecture" + "Appliquer la stratÃ©gie de groupe"

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
COMMANDES DE VÃ‰RIFICATION COMPLÃˆTES
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

# VÃ©rifier l'emplacement de l'utilisateur
Get-ADUser -Identity $UserName | Select-Object Name, DistinguishedName

# VÃ©rifier le lien GPO
Get-GPLink -Target "OU=Comptabilite,OU=Utilisateurs,$($ouRacine.DistinguishedName)" | 
    Select-Object DisplayName, Enabled, Enforced

# VÃ©rifier le filtrage de sÃ©curitÃ©
Get-GPPermission -Name "$GPOName" -All | 
    Where-Object {`$_.Permission -eq "GpoApply"} | 
    Select-Object Trustee, Permission

# VÃ©rifier l'Ã©tat de la GPO
Get-GPO -Name "$GPOName" | Select-Object DisplayName, GpoStatus

# Sur le client (en tant que $UserName)
gpupdate /force
gpresult /h C:\rapport_$UserName.html
gpresult /r

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ORDRE DE RÃ‰SOLUTION RECOMMANDÃ‰
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

1. Corriger l'emplacement de l'utilisateur (BUG 1)
2. Activer le lien GPO (BUG 2)
3. Corriger le filtrage de sÃ©curitÃ© (BUG 3)
4. Sur le client : gpupdate /force
5. Fermer/rouvrir la session de $UserName
6. Tester : le Panneau de configuration doit Ãªtre bloquÃ©

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
FIN DU DOCUMENT DE RÃ‰FÃ‰RENCE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
"@

$referenceContent | Out-File -FilePath $referenceFile -Encoding UTF8
Write-Host "ğŸ“„ Fichier de rÃ©fÃ©rence crÃ©Ã© : $referenceFile" -ForegroundColor Cyan
Write-Host "   (Ã€ conserver pour la correction, ne pas donner aux Ã©tudiants !)" -ForegroundColor Gray
Write-Host ""
